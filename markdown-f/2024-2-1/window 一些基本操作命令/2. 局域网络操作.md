局域网网内ping不通的故障解决方法总结 .

ping的过程，无论是源主机发出request请求还是目的主机回reply的过程，都是首先根据目的ip查找本地路由表，确定下一跳的出口，然后根据下一跳的ip在arp缓存里确定是否有下一跳ip的mac地址，没有就发出arp请求去查找。有的话，二层和ip层组包发出。

       具体过程是，输完命令后，根据目的ip，先查路由表，看目的主机ip是否走==直连路由==，是就去检查mac地址缓存表，看是否==有该地址的mac地址缓存==，没有的话，是用直连路由的一个本机接口去发出请求目的ip的mac地址的arp请求request消息，收到arp响应后，用这个mac地址封装二层数据，发出icmp协议的ping请求消息。mac地址缓存里有，直接封装ping的request消息。没有得到mac地址，不发出ping的request消息，回显目的主机不可达。而没有错误时，组包发出，目的主机收到后，同样的过程根据收到包的源ip进行查路由表，查mac地址缓存，发包的的过程。              
原文链接：https://blog.csdn.net/wj31932/article/details/89633071


## 1.查路由表
发现不是直连路由和静态路由的话，走默认路由的话，就去查是否有默认网关的mac地址，没有去请求网关的mac地址，有就直接封装ping的request消息。若目的主机收到后，由于回程路由缺失原因，防火墙原因在网络层拦截icmp探查消息，入口或者出口不一致等，没有按原路返回，或没有回复，主机在等reply超时后，会有相应的超时显示。若目的网关未找到目的主机，或者经过的节点设备发现有错误，无法到达目的主机，会选择正常时的回复接口ip给源主机发出一个icmp错误消息，提示源主机。源主机会回显错误提示。网关发给转发给目的主机，目的主机收到后，同样走查本地路由表，查下一跳ip的mac地址，二三层组包发出的过程。
## 2. ping的错误回显
内容与icmp的差错消息相关的，根据回显报错的节点ip和内容，我们能知道那个节点出现问题，什么问题？
     ping时常见的icmp错误主要有下面几种：

     1. 目的主机不可达  destnation host  unreachable          目的网络中找不到目的主机

     2. 目的网络不可达  destnation network  unreachable    经过节点没有路由可达，或者经过节点设备存在acl拦截

     3. 传输失败，一般错误  transmit failed. General failure  源设备中没有默认路由

     4. ttl传输中过期    ttl exceeded           目标ip网段在环境中存在路由环路

     5. 路由重定向   icmp redirect              路由错误，比如目的ip应该走直连路由却送到网关上去了

       我们知道两台设备要进行通信，必须的组网结构是源设备，源目的接入通信链路，节点交换设备（二层，三层），和相应的中继通信链路，目的设备接入链路，目的设备这些基本的网络要素。ping的过程，这些要素都可能影响ping的结果。      
ping的过程和自身路由表，源和目的设备的接入通信链路二层广播通道是否通畅？访问目的ip的途径路径的节点交换设备路由设置，中继链路的状态，目的点的路由设置，对方设备的状态，目的设备防火墙是否阻止ping的请求消息通过相关等等因素相关。
## 3. ping具体排查过程
### 3.1 应该用ipconfig/all查看对应网络连接的物理状态。
### 3.2 当没有媒体已断开的显示时，这时用arp  -a | findstr  ip地址，看是否获取到对应的ip地址的mac，没有的话。
### 3.3应该是ping命令执行时，发出的请求对方的mac地址的arp消息没有得到应答，此时根本没有发出ping的request消息。这时，要检查对方是否开机？ip是否存在？有跨交换机vlan的话，检查对应的中间trunk链路是否导通？arp消息是否能到达目的ip侧？对方是否收到arp请求消息？走直连路由是否正确？（应该走默认路由，而走了直连路由，不正确的话，检查路由表是否存在掩码之类错误）最好能在对方pc上抓包，看arp请求消息是否到达目的地址的主机，再逐级排查。
